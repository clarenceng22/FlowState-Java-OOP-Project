package flowstate;

import javax.swing.*;
import javax.swing.border.*;
import java.awt.*;
import java.awt.event.*;
import java.time.LocalDate;
import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.Map;
import javax.swing.Timer;

public class FlowStateGUI extends JFrame {

    private TaskManager manager;
    private DefaultListModel<String> taskListModel;
    private JList<String> taskList;
    
    // Tab management
    private Map<String, ArrayList<Task>> tabTasks;
    private String currentTab = "General";
    private JPanel tabPanel;
    private Map<String, JButton> tabButtons;

    // UI Components
    private JScrollPane scrollPane;
    private JPanel mainContainer;
    private JPanel leftSidebar;
    private JPanel rightPanel;
    private JLabel toastLabel;
    private JLabel titleLabel;
    private JButton darkModeButton;
    private JButton addTabButton;

    private Timer toastTimer;
    private boolean darkMode = false;
    
    // Right panel components
    private JLabel selectedTaskTitle;
    private JTextField editTitleField;
    private JTextArea editDescriptionArea;
    private JLabel editDateLabel;
    private JComboBox<String> priorityBox;
    private JCheckBox completedCheckbox;
    private Task currentSelectedTask;
    private int currentSelectedIndex = -1;

    public FlowStateGUI() {
        Storage storage = new FileStorage();
        manager = new TaskManager(storage);

        // Initialize tab system
        tabTasks = new HashMap<>();
        tabButtons = new HashMap<>();
        initializeTabs();

        setTitle("FlowState - Task Management");
        setSize(1400, 800);
        setLocationRelativeTo(null);
        setDefaultCloseOperation(JFrame.DO_NOTHING_ON_CLOSE);
        setResizable(true);

        mainContainer = new JPanel(new BorderLayout());
        
        // Top bar
        JPanel topBar = createTopBar();
        mainContainer.add(topBar, BorderLayout.NORTH);

        // Left sidebar with tabs
        leftSidebar = createLeftSidebar();
        
        // Center task list
        createTaskList();
        
        // Right panel for editing
        rightPanel = createRightPanel();

        // Main content: left sidebar + task list + right panel
        JPanel centerContent = new JPanel(new BorderLayout());
        centerContent.add(leftSidebar, BorderLayout.WEST);
        centerContent.add(scrollPane, BorderLayout.CENTER);
        centerContent.add(rightPanel, BorderLayout.EAST);
        
        mainContainer.add(centerContent, BorderLayout.CENTER);

        // Bottom toast
        toastLabel = new JLabel(" ");
        toastLabel.setHorizontalAlignment(SwingConstants.CENTER);
        toastLabel.setFont(nunitoBold(12));
        mainContainer.add(toastLabel, BorderLayout.SOUTH);

        add(mainContainer);
        applyTheme();
        selectTab("General");

        addWindowListener(new java.awt.event.WindowAdapter() {
            @Override
            public void windowClosing(java.awt.event.WindowEvent e) {
                saveTasks();
                dispose();
            }
        });

        setVisible(true);
    }

    private void initializeTabs() {
        tabTasks.put("Personal", new ArrayList<>());
        tabTasks.put("Work", new ArrayList<>());
        tabTasks.put("General", new ArrayList<>());
        loadTabsFromStorage();
    }

    private void loadTabsFromStorage() {
        ArrayList<Task> allTasks = manager.getTasks();
        for (Task t : allTasks) {
            tabTasks.get("General").add(t);
        }
    }

    private JPanel createTopBar() {
        JPanel topBar = new JPanel(new BorderLayout());
        topBar.setBorder(BorderFactory.createEmptyBorder(12, 15, 12, 15));
        
        titleLabel = new JLabel("[âœ“] FlowState");
        titleLabel.setFont(nunitoBold(26));

        darkModeButton = new JButton(darkMode ? "[L] Light" : "[D] Dark");
        darkModeButton.setFont(nunitoBold(11));
        darkModeButton.setFocusPainted(false);
        darkModeButton.setCursor(new Cursor(Cursor.HAND_CURSOR));
        darkModeButton.addActionListener(e -> {
            darkMode = !darkMode;
            applyTheme();
            darkModeButton.setText(darkMode ? "[L] Light" : "[D] Dark");
        });

        JPanel rightTop = new JPanel(new FlowLayout(FlowLayout.RIGHT, 10, 0));
        rightTop.add(darkModeButton);
        rightTop.setOpaque(false);

        topBar.add(titleLabel, BorderLayout.WEST);
        topBar.add(rightTop, BorderLayout.EAST);
        
        return topBar;
    }

    private JPanel createLeftSidebar() {
        JPanel sidebar = new JPanel();
        sidebar.setLayout(new BoxLayout(sidebar, BoxLayout.Y_AXIS));
        sidebar.setPreferredSize(new Dimension(180, 0));
        sidebar.setBorder(BorderFactory.createEmptyBorder(10, 10, 10, 10));

        tabPanel = new JPanel();
        tabPanel.setLayout(new BoxLayout(tabPanel, BoxLayout.Y_AXIS));

        // Create default tabs
        createTabButton("Personal");
        createTabButton("Work");
        createTabButton("General");

        JScrollPane tabScroll = new JScrollPane(tabPanel);
        tabScroll.setBorder(BorderFactory.createEmptyBorder());
        sidebar.add(tabScroll);

        // Add new tab button
        addTabButton = new JButton("+ New Tab");
        addTabButton.setFont(nunitoBold(11));
        addTabButton.setMaximumSize(new Dimension(Integer.MAX_VALUE, 35));
        addTabButton.setCursor(new Cursor(Cursor.HAND_CURSOR));
        addTabButton.addActionListener(e -> addNewTabDialog());
        sidebar.add(Box.createVerticalStrut(10));
        sidebar.add(addTabButton);

        sidebar.add(Box.createVerticalGlue());
        
        return sidebar;
    }

    private void createTabButton(String tabName) {
        JButton tabBtn = new JButton(tabName);
        tabBtn.setFont(nunitoBold(12));
        tabBtn.setMaximumSize(new Dimension(Integer.MAX_VALUE, 35));
        tabBtn.setCursor(new Cursor(Cursor.HAND_CURSOR));
        tabBtn.addActionListener(e -> selectTab(tabName));
        
        // Right-click to rename/delete
        tabBtn.addMouseListener(new MouseAdapter() {
            @Override
            public void mouseClicked(MouseEvent e) {
                if (SwingUtilities.isRightMouseButton(e)) {
                    showTabContextMenu(tabBtn, tabName, e.getX(), e.getY());
                }
            }
        });

        tabPanel.add(tabBtn);
        tabPanel.add(Box.createVerticalStrut(5));
        tabButtons.put(tabName, tabBtn);
    }

    private void showTabContextMenu(JButton tabBtn, String tabName, int x, int y) {
        if (tabName.equals("General")) {
            JOptionPane.showMessageDialog(this, "Cannot rename or delete the General tab.", "Info", JOptionPane.INFORMATION_MESSAGE);
            return;
        }

        JPopupMenu menu = new JPopupMenu();
        
        JMenuItem renameItem = new JMenuItem("Rename");
        renameItem.addActionListener(e -> renameTabDialog(tabName, tabBtn));
        menu.add(renameItem);

        JMenuItem deleteItem = new JMenuItem("Delete");
        deleteItem.addActionListener(e -> deleteTab(tabName, tabBtn));
        menu.add(deleteItem);

        menu.show(tabBtn, x, y);
    }

    private void renameTabDialog(String oldName, JButton tabBtn) {
        String newName = JOptionPane.showInputDialog(this, "New tab name:", oldName);
        if (newName != null && !newName.trim().isEmpty()) {
            newName = newName.trim();
            tabTasks.put(newName, tabTasks.remove(oldName));
            tabButtons.put(newName, tabButtons.remove(oldName));
            tabBtn.setText(newName);
            currentTab = newName;
            showToast("Tab renamed to: " + newName);
        }
    }

    private void deleteTab(String tabName, JButton tabBtn) {
        int confirm = JOptionPane.showConfirmDialog(this, "Delete tab '" + tabName + "'?", "Confirm", JOptionPane.YES_NO_OPTION);
        if (confirm == JOptionPane.YES_OPTION) {
            tabTasks.remove(tabName);
            tabButtons.remove(tabName);
            tabPanel.remove(tabBtn);
            tabPanel.revalidate();
            tabPanel.repaint();
            selectTab("General");
            showToast("Tab deleted");
        }
    }

    private void addNewTabDialog() {
        String tabName = JOptionPane.showInputDialog(this, "New tab name:");
        if (tabName != null && !tabName.trim().isEmpty()) {
            tabName = tabName.trim();
            if (tabTasks.containsKey(tabName)) {
                JOptionPane.showMessageDialog(this, "Tab already exists.", "Error", JOptionPane.ERROR_MESSAGE);
                return;
            }
            tabTasks.put(tabName, new ArrayList<>());
            createTabButton(tabName);
            tabPanel.revalidate();
            tabPanel.repaint();
            selectTab(tabName);
            showToast("Tab created: " + tabName);
        }
    }

    private void selectTab(String tabName) {
        currentTab = tabName;
        
        // Update button styles
        for (Map.Entry<String, JButton> entry : tabButtons.entrySet()) {
            if (entry.getKey().equals(tabName)) {
                entry.getValue().setBackground(new Color(59, 130, 246));
                entry.getValue().setForeground(Color.white);
                entry.getValue().setOpaque(true);
            } else {
                entry.getValue().setBackground(UIManager.getColor("Button.background"));
                entry.getValue().setForeground(UIManager.getColor("Button.foreground"));
            }
        }

        refreshTaskList();
    }

    private void createTaskList() {
        taskListModel = new DefaultListModel<>();
        taskList = new JList<>(taskListModel);
        taskList.setFont(nunitoBold(14));
        taskList.setFixedCellHeight(45);
        taskList.setCellRenderer(new TaskRenderer());
        taskList.setSelectionMode(ListSelectionModel.SINGLE_SELECTION);

        taskList.addListSelectionListener(e -> {
            if (!e.getValueIsAdjusting()) {
                currentSelectedIndex = taskList.getSelectedIndex();
                if (currentSelectedIndex >= 0) {
                    currentSelectedTask = tabTasks.get(currentTab).get(currentSelectedIndex);
                    updateRightPanel();
                }
            }
        });

        // Right-click context menu
        taskList.addMouseListener(new MouseAdapter() {
            @Override
            public void mouseClicked(MouseEvent e) {
                if (SwingUtilities.isRightMouseButton(e)) {
                    int index = taskList.locationToIndex(e.getPoint());
                    if (index >= 0) {
                        taskList.setSelectedIndex(index);
                        showTaskContextMenu(e.getX(), e.getY());
                    }
                }
            }
        });

        scrollPane = new JScrollPane(taskList);
        scrollPane.setBorder(BorderFactory.createLineBorder(new Color(200, 220, 240), 1));
        scrollPane.getVerticalScrollBar().setUnitIncrement(15);
    }

    private void showTaskContextMenu(int x, int y) {
        JPopupMenu menu = new JPopupMenu();

        JMenuItem addItem = new JMenuItem("+ Add Task");
        addItem.addActionListener(e -> addTaskDialog());
        menu.add(addItem);

        menu.addSeparator();

        JMenuItem editTitleItem = new JMenuItem("Edit Title");
        editTitleItem.addActionListener(e -> updateRightPanel());
        menu.add(editTitleItem);

        JMenuItem editDescItem = new JMenuItem("Edit Description");
        editDescItem.addActionListener(e -> {
            if (editDescriptionArea != null) {
                editDescriptionArea.requestFocus();
            }
        });
        menu.add(editDescItem);

        JMenuItem editDateItem = new JMenuItem("Edit Due Date");
        editDateItem.addActionListener(e -> editDueDate());
        menu.add(editDateItem);

        JMenuItem editPriorityItem = new JMenuItem("Edit Priority");
        editPriorityItem.addActionListener(e -> {
            if (priorityBox != null) {
                priorityBox.requestFocus();
            }
        });
        menu.add(editPriorityItem);

        menu.addSeparator();

        JMenuItem completeItem = new JMenuItem("Mark as Complete");
        completeItem.addActionListener(e -> {
            if (currentSelectedTask != null) {
                currentSelectedTask.setCompleted(!currentSelectedTask.isCompleted());
                refreshTaskList();
                updateRightPanel();
                showToast(currentSelectedTask.isCompleted() ? "Task completed" : "Task incomplete");
            }
        });
        menu.add(completeItem);

        JMenuItem deleteItem = new JMenuItem("Delete Task");
        deleteItem.addActionListener(e -> deleteTask());
        menu.add(deleteItem);

        menu.show(taskList, x, y);
    }

    private JPanel createRightPanel() {
        JPanel panel = new JPanel();
        panel.setLayout(new BoxLayout(panel, BoxLayout.Y_AXIS));
        panel.setPreferredSize(new Dimension(300, 0));
        panel.setBorder(BorderFactory.createEmptyBorder(15, 15, 15, 15));

        selectedTaskTitle = new JLabel("Select a task");
        selectedTaskTitle.setFont(nunitoBold(16));
        panel.add(selectedTaskTitle);
        panel.add(Box.createVerticalStrut(15));

        // Title editor
        JLabel titleLabel = new JLabel("Title:");
        titleLabel.setFont(nunitoBold(12));
        panel.add(titleLabel);
        
        editTitleField = new JTextField();
        editTitleField.setFont(new Font("Arial", Font.PLAIN, 12));
        editTitleField.setMaximumSize(new Dimension(Integer.MAX_VALUE, 30));
        editTitleField.addActionListener(e -> saveTaskChanges());
        editTitleField.addFocusListener(new FocusAdapter() {
            @Override
            public void focusLost(FocusEvent e) {
                saveTaskChanges();
            }
        });
        panel.add(editTitleField);
        panel.add(Box.createVerticalStrut(10));

        // Description editor
        JLabel descLabel = new JLabel("Description:");
        descLabel.setFont(nunitoBold(12));
        panel.add(descLabel);
        
        editDescriptionArea = new JTextArea(4, 20);
        editDescriptionArea.setFont(new Font("Arial", Font.PLAIN, 11));
        editDescriptionArea.setLineWrap(true);
        editDescriptionArea.setWrapStyleWord(true);
        editDescriptionArea.addFocusListener(new FocusAdapter() {
            @Override
            public void focusLost(FocusEvent e) {
                saveTaskChanges();
            }
        });
        JScrollPane descScroll = new JScrollPane(editDescriptionArea);
        panel.add(descScroll);
        panel.add(Box.createVerticalStrut(10));

        // Due date
        JLabel dateLabel = new JLabel("Due Date:");
        dateLabel.setFont(nunitoBold(12));
        panel.add(dateLabel);
        
        editDateLabel = new JLabel("No date");
        editDateLabel.setFont(new Font("Arial", Font.PLAIN, 11));
        editDateLabel.setCursor(new Cursor(Cursor.HAND_CURSOR));
        editDateLabel.addMouseListener(new MouseAdapter() {
            @Override
            public void mouseClicked(MouseEvent e) {
                editDueDate();
            }
        });
        panel.add(editDateLabel);
        panel.add(Box.createVerticalStrut(10));

        // Priority
        JLabel priorityLabel = new JLabel("Priority:");
        priorityLabel.setFont(nunitoBold(12));
        panel.add(priorityLabel);
        
        String[] priorities = {"Low", "Medium", "High"};
        priorityBox = new JComboBox<>(priorities);
        priorityBox.setFont(new Font("Arial", Font.PLAIN, 11));
        priorityBox.setMaximumSize(new Dimension(Integer.MAX_VALUE, 30));
        priorityBox.addActionListener(e -> saveTaskChanges());
        panel.add(priorityBox);
        panel.add(Box.createVerticalStrut(10));

        // Completed checkbox
        completedCheckbox = new JCheckBox("Completed");
        completedCheckbox.setFont(new Font("Arial", Font.PLAIN, 11));
        completedCheckbox.addActionListener(e -> saveTaskChanges());
        panel.add(completedCheckbox);
        
        panel.add(Box.createVerticalGlue());
        
        return panel;
    }

    private void updateRightPanel() {
        if (currentSelectedTask == null) {
            selectedTaskTitle.setText("Select a task");
            editTitleField.setText("");
            editDescriptionArea.setText("");
            editDateLabel.setText("No date");
            priorityBox.setSelectedItem("Medium");
            completedCheckbox.setSelected(false);
            return;
        }

        selectedTaskTitle.setText(currentSelectedTask.getTitle());
        editTitleField.setText(currentSelectedTask.getTitle());
        editDescriptionArea.setText(currentSelectedTask.getDescription());
        editDateLabel.setText(currentSelectedTask.getDueDate() != null ? currentSelectedTask.getDueDate() : "No date");
        priorityBox.setSelectedItem(currentSelectedTask.getPriority());
        completedCheckbox.setSelected(currentSelectedTask.isCompleted());
    }

    private void editDueDate() {
        if (currentSelectedTask == null) return;

        String[] months = {
                "01 - January", "02 - February", "03 - March", "04 - April",
                "05 - May", "06 - June", "07 - July", "08 - August",
                "09 - September", "10 - October", "11 - November", "12 - December"
        };

        String[] days = new String[31];
        for (int i = 0; i < 31; i++) days[i] = String.format("%02d", i + 1);

        String[] years = new String[6];
        int yearNow = LocalDate.now().getYear();
        for (int i = 0; i < 6; i++) years[i] = String.valueOf(yearNow + i);

        JComboBox<String> monthBox = new JComboBox<>(months);
        JComboBox<String> dayBox = new JComboBox<>(days);
        JComboBox<String> yearBox = new JComboBox<>(years);

        JPanel panel = new JPanel(new GridLayout(2, 3, 5, 5));
        panel.add(new JLabel("Month:"));
        panel.add(new JLabel("Day:"));
        panel.add(new JLabel("Year:"));
        panel.add(monthBox);
        panel.add(dayBox);
        panel.add(yearBox);

        int result = JOptionPane.showConfirmDialog(this, panel, "Select due date", JOptionPane.OK_CANCEL_OPTION);
        if (result == JOptionPane.OK_OPTION) {
            String month = ((String) monthBox.getSelectedItem()).substring(0, 2);
            String day = (String) dayBox.getSelectedItem();
            String year = (String) yearBox.getSelectedItem();
            String dueDate = month + "/" + day + "/" + year;
            
            currentSelectedTask.setDueDate(dueDate);
            editDateLabel.setText(dueDate);
            saveTaskChanges();
        }
    }

    private void saveTaskChanges() {
        if (currentSelectedTask == null) return;

        currentSelectedTask.setTitle(editTitleField.getText());
        currentSelectedTask.setDescription(editDescriptionArea.getText());
        currentSelectedTask.setPriority((String) priorityBox.getSelectedItem());
        currentSelectedTask.setCompleted(completedCheckbox.isSelected());

        saveTasks();
        refreshTaskList();
        selectedTaskTitle.setText(currentSelectedTask.getTitle());
        showToast("Changes saved");
    }

    private void addTaskDialog() {
        JPanel panel = new JPanel(new GridLayout(4, 1, 0, 10));
        panel.setBorder(BorderFactory.createEmptyBorder(10, 10, 10, 10));

        JLabel titleLabel = new JLabel("Task Title:");
        titleLabel.setFont(nunitoBold(12));
        JTextField titleField = new JTextField(20);
        
        JLabel descLabel = new JLabel("Description:");
        descLabel.setFont(nunitoBold(12));
        JTextArea descArea = new JTextArea(3, 20);
        descArea.setLineWrap(true);
        descArea.setWrapStyleWord(true);
        
        panel.add(titleLabel);
        panel.add(titleField);
        panel.add(descLabel);
        panel.add(new JScrollPane(descArea));

        int result = JOptionPane.showConfirmDialog(this, panel, "+ Add New Task", JOptionPane.OK_CANCEL_OPTION);
        if (result != JOptionPane.OK_OPTION) return;

        String title = titleField.getText().trim();
        String desc = descArea.getText().trim();
        if (title.isEmpty()) {
            JOptionPane.showMessageDialog(this, "Task title cannot be empty.", "Error", JOptionPane.ERROR_MESSAGE);
            return;
        }

        String due = showDatePickerDialog();
        if (due == null) return;

        String[] priorities = {"Low", "Medium", "High"};
        String priority = (String) JOptionPane.showInputDialog(this, "Select Priority:", "Priority",
                JOptionPane.PLAIN_MESSAGE, null, priorities, "Medium");
        if (priority == null) return;

        Task task = new Task(title, desc, due, priority);
        tabTasks.get(currentTab).add(task);
        manager.addTask(task);
        saveTasks();
        refreshTaskList();
        showToast("Task added");
    }

    private void deleteTask() {
        if (currentSelectedIndex < 0) return;

        int confirm = JOptionPane.showConfirmDialog(this, "Delete this task?", "Confirm Delete",
                JOptionPane.YES_NO_OPTION, JOptionPane.WARNING_MESSAGE);
        if (confirm != JOptionPane.YES_OPTION) return;

        tabTasks.get(currentTab).remove(currentSelectedIndex);
        manager.deleteTask(currentSelectedIndex);
        saveTasks();
        refreshTaskList();
        currentSelectedIndex = -1;
        currentSelectedTask = null;
        updateRightPanel();
        showToast("Task deleted");
    }

    private String showDatePickerDialog() {
        String[] months = {
                "01 - January", "02 - February", "03 - March", "04 - April",
                "05 - May", "06 - June", "07 - July", "08 - August",
                "09 - September", "10 - October", "11 - November", "12 - December"
        };

        String[] days = new String[31];
        for (int i = 0; i < 31; i++) days[i] = String.format("%02d", i + 1);

        String[] years = new String[6];
        int yearNow = LocalDate.now().getYear();
        for (int i = 0; i < 6; i++) years[i] = String.valueOf(yearNow + i);

        JComboBox<String> monthBox = new JComboBox<>(months);
        JComboBox<String> dayBox = new JComboBox<>(days);
        JComboBox<String> yearBox = new JComboBox<>(years);

        JPanel panel = new JPanel(new GridLayout(2, 3, 5, 5));
        panel.add(new JLabel("Month:"));
        panel.add(new JLabel("Day:"));
        panel.add(new JLabel("Year:"));
        panel.add(monthBox);
        panel.add(dayBox);
        panel.add(yearBox);

        int result = JOptionPane.showConfirmDialog(this, panel, "Select due date",
                JOptionPane.OK_CANCEL_OPTION, JOptionPane.PLAIN_MESSAGE);

        if (result != JOptionPane.OK_OPTION) return null;

        String month = ((String) monthBox.getSelectedItem()).substring(0, 2);
        String day = (String) dayBox.getSelectedItem();
        String year = (String) yearBox.getSelectedItem();

        return month + "/" + day + "/" + year;
    }

    private Font nunitoBold(int size) {
        try {
            Font font = Font.createFont(Font.TRUETYPE_FONT, new java.io.File("fonts/Nunito-VariableFont_wght.ttf"));
            return font.deriveFont(Font.BOLD, size);
        } catch (Exception e) {
            return new Font("Arial", Font.BOLD, size);
        }
    }

    private void styleButton(JButton button, Color bg, Color border, Color text) {
        button.setFont(nunitoBold(13));
        button.setBackground(bg);
        button.setForeground(text);
        button.setFocusPainted(false);
        button.setCursor(new Cursor(Cursor.HAND_CURSOR));
        button.setBorder(BorderFactory.createCompoundBorder(
                BorderFactory.createLineBorder(border, 1),
                BorderFactory.createEmptyBorder(10, 16, 10, 16)
        ));
        button.setOpaque(true);
    }

    private void applyTheme() {
        Color bgMain, bgList, selList, btnBg, btnBorder, textColor, toastColor;

        if (!darkMode) {
            bgMain = new Color(248, 250, 255);
            bgList = Color.white;
            selList = new Color(215, 235, 255);
            btnBg = new Color(59, 130, 246);
            btnBorder = new Color(37, 99, 235);
            textColor = new Color(20, 25, 40);
            toastColor = new Color(59, 130, 246);
        } else {
            bgMain = new Color(17, 24, 39);
            bgList = new Color(31, 41, 55);
            selList = new Color(55, 85, 140);
            btnBg = new Color(59, 130, 246);
            btnBorder = new Color(37, 99, 235);
            textColor = new Color(240, 245, 255);
            toastColor = new Color(147, 197, 253);
        }

        mainContainer.setBackground(bgMain);
        leftSidebar.setBackground(bgMain);
        rightPanel.setBackground(bgMain);

        scrollPane.getViewport().setBackground(bgList);
        taskList.setBackground(bgList);
        taskList.setSelectionBackground(selList);
        taskList.setForeground(textColor);

        toastLabel.setForeground(toastColor);

        styleButton(addTabButton, btnBg, btnBorder, Color.white);
        styleButton(darkModeButton, btnBg, btnBorder, Color.white);

        for (JButton btn : tabButtons.values()) {
            if (btn.getText().equals(currentTab)) {
                styleButton(btn, btnBg, btnBorder, Color.white);
            } else {
                btn.setBackground(UIManager.getColor("Button.background"));
                btn.setForeground(UIManager.getColor("Button.foreground"));
            }
        }

        editTitleField.setBackground(bgList);
        editTitleField.setForeground(textColor);
        editTitleField.setCaretColor(textColor);

        editDescriptionArea.setBackground(bgList);
        editDescriptionArea.setForeground(textColor);
        editDescriptionArea.setCaretColor(textColor);

        refreshTaskList();
    }

    private void showToast(String message) {
        if (toastTimer != null && toastTimer.isRunning()) {
            toastTimer.stop();
        }
        toastLabel.setText(message);
        toastTimer = new Timer(3000, e -> toastLabel.setText(" "));
        toastTimer.setRepeats(false);
        toastTimer.start();
    }

    private void refreshTaskList() {
        taskListModel.clear();
        ArrayList<Task> tasks = tabTasks.get(currentTab);

        if (tasks.isEmpty()) {
            taskListModel.addElement("(empty) No tasks yet.");
            return;
        }

        DateTimeFormatter inputFormat = DateTimeFormatter.ofPattern("MM/dd/yyyy");
        DateTimeFormatter prettyFormat = DateTimeFormatter.ofPattern("MMM d");
        LocalDate today = LocalDate.now();

        for (Task t : tasks) {
            String dateStatus = "No date";
            LocalDate dueDate = null;

            try {
                if (t.getDueDate() != null && !t.getDueDate().trim().isEmpty()) {
                    dueDate = LocalDate.parse(t.getDueDate(), inputFormat);
                    String formattedDate = dueDate.format(prettyFormat);
                    
                    if (t.isCompleted()) {
                        dateStatus = formattedDate + " [done]";
                    } else if (dueDate.isBefore(today)) {
                        dateStatus = formattedDate + " [OVERDUE]";
                    } else if (dueDate.equals(today)) {
                        dateStatus = "Today [NOW]";
                    } else {
                        dateStatus = formattedDate;
                    }
                }
            } catch (Exception e) {
                dateStatus = t.getDueDate();
            }

            String priorityIcon = "[L]";
            String priorityColor = "#7FD56F";
            if (t.getPriority().equalsIgnoreCase("High")) {
                priorityColor = "#EF4444";
                priorityIcon = "[H]";
            } else if (t.getPriority().equalsIgnoreCase("Medium")) {
                priorityColor = "#FBBF24";
                priorityIcon = "[M]";
            }

            String baseColor;
            if (t.isCompleted()) {
                baseColor = darkMode ? "#888888" : "#999999";
            } else if (dueDate != null && dueDate.isBefore(today)) {
                baseColor = "#EF4444";
            } else if (dueDate != null && dueDate.equals(today)) {
                baseColor = "#F59E0B";
            } else {
                baseColor = darkMode ? "#E5E7EB" : "#1F2937";
            }

            String left = "<span style='color:" + baseColor + ";'><b>" + t.getTitle() + "</b></span> " +
                    "<span style='color:" + priorityColor + ";'>" + priorityIcon + "</span>";
            String right = "<span style='color:" + baseColor + ";'>" + dateStatus + "</span>";

            taskListModel.addElement(left + ":::" + right);
        }
    }

    private void saveTasks() {
        manager.saveTasks();
    }

    private class TaskRenderer extends JPanel implements ListCellRenderer<String> {
        private JLabel leftLabel;
        private JLabel rightLabel;

        public TaskRenderer() {
            setLayout(new BorderLayout());
            setBorder(BorderFactory.createEmptyBorder(8, 12, 8, 12));

            leftLabel = new JLabel();
            leftLabel.setFont(nunitoBold(13));

            rightLabel = new JLabel();
            rightLabel.setFont(nunitoBold(11));
            rightLabel.setHorizontalAlignment(SwingConstants.RIGHT);

            add(leftLabel, BorderLayout.WEST);
            add(rightLabel, BorderLayout.EAST);
        }

        @Override
        public Component getListCellRendererComponent(JList<? extends String> list, String value, int index,
                boolean isSelected, boolean cellHasFocus) {
            String[] parts = value.split(":::");
            String left = parts[0];
            String right = parts.length > 1 ? parts[1] : "";

            leftLabel.setText("<html>" + left + "</html>");
            rightLabel.setText("<html>" + right + "</html>");

            if (isSelected) {
                setBackground(list.getSelectionBackground());
            } else {
                setBackground(list.getBackground());
            }
            
            setOpaque(true);
            return this;
        }
    }

    public static void main(String[] args) {
        SwingUtilities.invokeLater(() -> {
            FlowStateGUI gui = new FlowStateGUI();
        });
    }
}
